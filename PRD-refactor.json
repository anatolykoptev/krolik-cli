{
  "version": "1.0",
  "project": "krolik-cli",
  "title": "Iterative Refactoring to Acceptable Quality Level",
  "description": "Run refactoring until all critical issues and 100% duplicates are resolved",
  "createdAt": "2026-01-16T10:00:00Z",
  "config": {
    "maxAttempts": 3,
    "continueOnFailure": false,
    "model": "sonnet"
  },
  "tasks": [
    {
      "id": "refactor-001-duplicates",
      "title": "Merge 100% similar functions (semantic clones)",
      "description": "Find and merge all semantic clones with 100% similarity into shared utility modules",
      "acceptance_criteria": [
        {
          "id": "ac-001-1",
          "description": "getRalphDatabase merged into single location",
          "expected": "Function exists only in one file, other locations import it"
        },
        {
          "id": "ac-001-2",
          "description": "getConfidenceLabel/scoreToGrade/formatRank merged",
          "expected": "Single implementation in lib/@core with re-exports"
        },
        {
          "id": "ac-001-3",
          "description": "hookTemplate/reactHookTemplate merged",
          "expected": "Single template in codegen/templates"
        },
        {
          "id": "ac-001-4",
          "description": "TypeScript compilation passes",
          "testCommand": "bun run typecheck",
          "expected": "Exit code 0"
        }
      ],
      "dependencies": [],
      "priority": "critical",
      "complexity": "moderate",
      "labels": ["refactor", "duplicates", "cleanup"],
      "relatedFiles": [
        "src/lib/@storage/ralph/attempts.ts",
        "src/lib/@storage/ralph/guardrails.ts",
        "src/lib/@storage/ralph/sessions.ts",
        "src/commands/audit/impact/git-history.ts",
        "src/commands/audit/readability/index.ts"
      ]
    },
    {
      "id": "refactor-002-formatter",
      "title": "Split formatter.ts (765 lines)",
      "description": "Split src/lib/@reporter/formatter.ts into smaller focused modules",
      "acceptance_criteria": [
        {
          "id": "ac-002-1",
          "description": "Main file under 300 lines",
          "expected": "formatter.ts has less than 300 lines"
        },
        {
          "id": "ac-002-2",
          "description": "Extracted modules created",
          "expected": "New files: xml-formatter.ts, text-formatter.ts, formatters/index.ts"
        },
        {
          "id": "ac-002-3",
          "description": "All exports preserved",
          "expected": "Public API unchanged, imports work"
        },
        {
          "id": "ac-002-4",
          "description": "TypeScript compilation passes",
          "testCommand": "bun run typecheck",
          "expected": "Exit code 0"
        }
      ],
      "dependencies": ["refactor-001-duplicates"],
      "priority": "high",
      "complexity": "moderate",
      "labels": ["refactor", "split", "reporter"],
      "relatedFiles": ["src/lib/@reporter/formatter.ts"]
    },
    {
      "id": "refactor-003-unified-swc",
      "title": "Split unified-swc.ts (670 lines)",
      "description": "Split src/commands/fix/analyzers/unified-swc.ts into focused analyzers",
      "acceptance_criteria": [
        {
          "id": "ac-003-1",
          "description": "Main file under 300 lines",
          "expected": "unified-swc.ts has less than 300 lines"
        },
        {
          "id": "ac-003-2",
          "description": "Analyzer modules extracted",
          "expected": "Separate files for each analyzer type"
        },
        {
          "id": "ac-003-3",
          "description": "TypeScript compilation passes",
          "testCommand": "bun run typecheck",
          "expected": "Exit code 0"
        }
      ],
      "dependencies": ["refactor-002-formatter"],
      "priority": "high",
      "complexity": "moderate",
      "labels": ["refactor", "split", "analyzers"],
      "relatedFiles": ["src/commands/fix/analyzers/unified-swc.ts"]
    },
    {
      "id": "refactor-004-memory-mcp",
      "title": "Split memory MCP tool (615 lines)",
      "description": "Split src/mcp/tools/memory/index.ts into action-based modules",
      "acceptance_criteria": [
        {
          "id": "ac-004-1",
          "description": "Main file under 300 lines",
          "expected": "index.ts has less than 300 lines"
        },
        {
          "id": "ac-004-2",
          "description": "Action handlers extracted",
          "expected": "Separate files: save.ts, search.ts, recent.ts, link.ts, chain.ts"
        },
        {
          "id": "ac-004-3",
          "description": "TypeScript compilation passes",
          "testCommand": "bun run typecheck",
          "expected": "Exit code 0"
        }
      ],
      "dependencies": ["refactor-003-unified-swc"],
      "priority": "high",
      "complexity": "moderate",
      "labels": ["refactor", "split", "mcp"],
      "relatedFiles": ["src/mcp/tools/memory/index.ts"]
    },
    {
      "id": "refactor-005-remaining",
      "title": "Split remaining oversized files",
      "description": "Split remaining files over 500 lines: complexity-swc.ts, database.ts, docs/index.ts, fix/index.ts, tag-extractor.ts",
      "acceptance_criteria": [
        {
          "id": "ac-005-1",
          "description": "complexity-swc.ts under 300 lines",
          "expected": "File split into focused modules"
        },
        {
          "id": "ac-005-2",
          "description": "database.ts under 300 lines",
          "expected": "Separate files for migrations, queries, utils"
        },
        {
          "id": "ac-005-3",
          "description": "docs/index.ts under 300 lines",
          "expected": "Actions extracted to separate files"
        },
        {
          "id": "ac-005-4",
          "description": "fix/index.ts under 300 lines",
          "expected": "Core logic extracted"
        },
        {
          "id": "ac-005-5",
          "description": "tag-extractor.ts under 300 lines",
          "expected": "Extractors split by type"
        },
        {
          "id": "ac-005-6",
          "description": "TypeScript compilation passes",
          "testCommand": "bun run typecheck",
          "expected": "Exit code 0"
        }
      ],
      "dependencies": ["refactor-004-memory-mcp"],
      "priority": "high",
      "complexity": "complex",
      "labels": ["refactor", "split", "cleanup"],
      "relatedFiles": [
        "src/commands/fix/analyzers/complexity-swc.ts",
        "src/lib/@storage/database.ts",
        "src/commands/docs/index.ts",
        "src/commands/fix/index.ts",
        "src/commands/context/repomap/tag-extractor.ts"
      ]
    },
    {
      "id": "refactor-006-verify",
      "title": "Run tests and verify quality",
      "description": "Run all tests and verify refactoring quality thresholds are met",
      "acceptance_criteria": [
        {
          "id": "ac-006-1",
          "description": "All tests pass",
          "testCommand": "bun test",
          "expected": "Exit code 0, all tests green"
        },
        {
          "id": "ac-006-2",
          "description": "No files over 500 lines",
          "testCommand": "bun run krolik refactor --quick",
          "expected": "error count = 0 in file-size-analysis"
        },
        {
          "id": "ac-006-3",
          "description": "No 100% duplicates",
          "expected": "No semantic clones with 100% similarity in duplicates section"
        }
      ],
      "dependencies": ["refactor-005-remaining"],
      "priority": "critical",
      "complexity": "simple",
      "labels": ["verify", "tests", "quality"]
    }
  ],
  "metadata": {
    "author": "AI Refactoring Agent",
    "tags": ["refactor", "quality", "cleanup", "duplicates"],
    "notes": "Iterative refactoring PRD. Goal: eliminate 100% duplicates and files >500 lines."
  }
}
